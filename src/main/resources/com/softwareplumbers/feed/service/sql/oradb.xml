<?xml version = "1.0" encoding = "UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:aop="http://www.springframework.org/schema/aop"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.3.xsd" 
    default-lazy-init="true"
>
    
    <context:annotation-config />
    
    <bean id="conversionService"
    class="org.springframework.context.support.ConversionServiceFactoryBean"/>
      
    <bean id="oracle.feed.dropScript" class="com.softwareplumbers.common.sql.Script">
        <property name="sql" >
            <value>
                DROP TABLE FEEDS;
                DROP TABLE MESSAGES;
            </value>
        </property>
        <property name="OnError" value="WARNING"/>
    </bean>
        
    <bean id="oracle.feed.createScript" class="com.softwareplumbers.common.sql.Script">
        <property name="sql" >
            <value>                
                CREATE TABLE FEEDS (
                    ID RAW(16) PRIMARY KEY,
                    PARENT_ID RAW(16),
                    NAME VARCHAR(255),
                    VERSION VARCHAR(255),
                    DELETED CHAR(1) DEFAULT 'N'
                );
                
                INSERT INTO FEEDS (ID) VALUES ('00000000000000000000000000000000');

                CREATE TABLE MESSAGES (
                    ID RAW(16) PRIMARY KEY,
                    FULL_NAME VARCHAR(256),
                    SENDER VARCHAR(256),
                    RECEIVED TIMESTAMP,
                    FEED_ID RAW(16),
                    HEADERS CLOB,
                    LENGTH INTEGER,
                    DATA BLOB,
                    TYPE VARCHAR(64),
                    SERVER_ID RAW(16),
                    REMOTE_SVR_ID RAW(16),
                    REMOTE_TIMESTAMP TIMESTAMP
                );
                
            </value>
        </property>
        <property name="OnError" value="WARNING"/>
    </bean>
    
    <bean id="oracle.feed.updateScript" class="com.softwareplumbers.common.sql.Script">        
        <property name="sql">
            <value>
                CREATE UNIQUE INDEX FEED_NAME ON FEEDS (PARENT_ID, NAME, VERSION);
            </value>
        </property>
        <property name="OnError" value="WARNING"/>
    </bean>
    
    <bean id="oracle.feed.operations" class="com.softwareplumbers.common.sql.OperationStore" scope="singleton">
        <constructor-arg>
            <map key-type="com.softwareplumbers.feed.service.sql.MessageDatabase.Operation">
                <entry key="CREATE_MESSAGE" value="INSERT INTO MESSAGES (ID, FULL_NAME, SENDER, RECEIVED, FEED_ID, HEADERS, LENGTH, DATA, TYPE, SERVER_ID, REMOTE_SVR_ID, REMOTE_TIMESTAMP) VALUES (?,?,?, (SELECT NEXT_TIMESTAMP FROM TIMSTAMP_SEQ) ,?,?,?,?,?,?,?,?)"/>
                <entry key="GET_NEW_MESSAGES" value="SELECT ID, FULL_NAME, SENDER, RECEIVED, FEED_ID, HEADERS, LENGTH, DATA, TYPE, SERVER_ID, REMOTE_SVR_ID, REMOTE_TIMESTAMP FROM MESSAGES JOIN TIMESTAMP_SEQ ON MESSAGES.RECEIVED = TIMESTAMP_SEQ.NEXT_TIMESTAMP WHERE FEED_ID=?"/>
                <entry key="GET_MESSAGES_BY_ID" value="SELECT ID, FULL_NAME, SENDER, RECEIVED, FEED_ID, HEADERS, LENGTH, DATA, TYPE, SERVER_ID, REMOTE_SVR_ID, REMOTE_TIMESTAMP FROM MESSAGES WHERE ID=?"/>
                <entry key="GET_FEED_BY_ID" value="SELECT ID, PARENT_ID, NAME, VERSION, DELETED FROM FEEDS WHERE FEED_ID=?"/>
                <entry key="GET_FEED_BY_ID_AND_NAME" value="SELECT ID, PARENT_ID, NAME, VERSION, DELETED FROM FEEDS WHERE PARENT_ID=? AND NAME=?"/>
                <entry key="CREATE_FEED" value="INSERT INTO FEEDS (ID, PARENT_ID, NAME, VERSION) VALUES (?,?,?,?)"/>
                <entry key="GENERATE_TIMESTAMP" value="UPDATE TIMESTAMP_SEQ SET NEXT_TIMESTAMP = CASEWHEN(CURRENT_TIMESTAMP(9) > NEXT_TIMESTAMP, CURRENT_TIMESTAMP(9), TIMESTAMPADD(NANOSECOND, 1, NEXT_TIMESTAMP))"/>
                <entry key="GET_NODE" value="SELECT ID, INIT_TIME FROM NODES WHERE ID=?"/>
                <entry key="GET_SELF" value="SELECT ID FROM SELF"/>
            </map>
        </constructor-arg>
    </bean>
    
    <bean id="oracle.feed.templates" class="com.softwareplumbers.common.sql.TemplateStore" scope="singleton"> 
        <constructor-arg>
            <map key-type="com.softwareplumbers.feed.service.sql.MessageDatabase.Template">
                <entry key="SELECT_MESSAGES" value="SELECT T0.ID, T0.FULL_NAME, T0.SENDER, T0.RECEIVED, T0.FEED_ID, T0.HEADERS, T0.LENGTH, T0.DATA !{0}"/>
            </map>
        </constructor-arg>
    </bean>
    
    <bean id="oracle.feed.schema" class="com.softwareplumbers.common.sql.Schema"> 
        <property name="createScript" ref="oracle.feed.createScript"/>
        <property name="updateScript" ref="oracle.feed.updateScript"/>
        <property name="dropScript" ref="oracle.feed.dropScript"/>
        <property name="supportedEntities" value="com.softwareplumbers.feed.service.sql.MessageDatabase.EntityType"/>
        <property name="supportedTypes" value="com.softwareplumbers.feed.service.sql.MessageDatabase.DataType"/>        
        <property name="entityMap" ref="feed.entityMap"/>
    </bean>
</beans>